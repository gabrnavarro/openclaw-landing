<!DOCTYPE html><!--FmlDgMI7snZSJRl5UO4eV--><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/openclaw-landing/_next/static/media/797e433ab948586e-s.p.dbea232f.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/openclaw-landing/_next/static/media/caa3a2e1cccd8315-s.p.853070df.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/openclaw-landing/_next/static/chunks/8c9da6df9e0ce34d.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/openclaw-landing/_next/static/chunks/b79d602f30593662.js"/><script src="/openclaw-landing/_next/static/chunks/75db382961acc07c.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/3e89c1f61fc01af4.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/1c9669fd87998ca9.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/turbopack-e3bd8c5c0242d6ef.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/744355e03808d4c7.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js" async=""></script><script src="/openclaw-landing/_next/static/chunks/7c92e96509cd355e.js" async=""></script><meta name="next-size-adjust" content=""/><title>Setting up an NGINX proxy using consul-template and puppet · Blog</title><meta name="description" content="Blog post from 2020-07-26: Setting up an NGINX proxy using consul-template and puppet"/><meta name="robots" content="index, follow"/><meta name="googlebot" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"/><link rel="canonical" href="https://gabrnavarro.github.io/openclaw-landing/"/><meta property="og:title" content="Kelly Navarro — Site Reliability Engineer"/><meta property="og:description" content="SRE with 7+ years running large-scale game and web infrastructure across AWS, GCP, and Azure."/><meta property="og:url" content="https://gabrnavarro.github.io/openclaw-landing/"/><meta property="og:site_name" content="Kelly Navarro"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Kelly Navarro — Site Reliability Engineer"/><meta name="twitter:description" content="SRE with 7+ years running large-scale game and web infrastructure across AWS, GCP, and Azure."/><link rel="icon" href="/openclaw-landing/favicon.ico?favicon.0b3bf435.ico" sizes="256x256" type="image/x-icon"/><script src="/openclaw-landing/_next/static/chunks/a6dad97d9634a72d.js" noModule=""></script></head><body class="geist_a71539c9-module__T19VSG__variable geist_mono_8d43a2aa-module__8Li5zG__variable antialiased"><div hidden=""><!--$--><!--/$--></div><div class="min-h-screen bg-white text-neutral-950"><div class="pointer-events-none fixed inset-0 -z-10"><div class="absolute inset-0 bg-gradient-to-b from-white via-white to-zinc-50"></div><div class="absolute left-1/2 top-[-240px] h-[520px] w-[520px] -translate-x-1/2 rounded-full bg-blue-200/35 blur-3xl"></div><div class="absolute left-[20%] top-[240px] h-[420px] w-[420px] rounded-full bg-emerald-200/25 blur-3xl"></div></div><main class="mx-auto w-full max-w-3xl px-6 py-16 sm:py-20"><div class="flex items-center justify-between"><a class="inline-flex h-10 items-center justify-center rounded-full border border-neutral-200 bg-white px-4 text-sm font-medium text-neutral-900 shadow-sm transition hover:bg-neutral-50" href="/openclaw-landing/blog/">← Blog</a><a class="inline-flex h-10 items-center justify-center rounded-full border border-neutral-200 bg-white px-4 text-sm font-medium text-neutral-900 shadow-sm transition hover:bg-neutral-50" href="/openclaw-landing/">Home</a></div><article class="mt-10 overflow-hidden rounded-3xl border border-neutral-200 bg-white shadow-sm"><header class="border-b border-neutral-100 p-6 sm:p-8"><div class="text-xs text-neutral-500">July 26, 2020</div><h1 class="mt-2 text-3xl font-semibold tracking-tight">Setting up an NGINX proxy using consul-template and puppet</h1><div class="mt-4 flex flex-wrap gap-2"><span class="rounded-full border border-neutral-200 bg-white px-2.5 py-1 text-[11px] text-neutral-700">nginx</span><span class="rounded-full border border-neutral-200 bg-white px-2.5 py-1 text-[11px] text-neutral-700">consul</span><span class="rounded-full border border-neutral-200 bg-white px-2.5 py-1 text-[11px] text-neutral-700">puppet</span></div></header><div class="prose prose-neutral blog-prose max-w-none p-6 sm:p-8 prose-headings:tracking-tight prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline"><p>Consul template is a wonderful tool that allows you to create configuration templates while interpolating consul resources and many important variables. You can also use these templates to automatically change the contents of your configuration files using the <code>watch</code> class in puppet.</p>
<p>To set up an nginx proxy using consul-template to control configuration, what you can do is initialize nginx using the <code>puppet-nginx</code> module and change the config files using consul template.</p>
<p>Here is the full code for reference. This is just what it should roughly look like, and I haven't tested this, so please read it and just take whichever parts you need to make it work.</p>
<pre><code>// init.pp
class sample_proxy() {
  include consul_template

  $nginx_template = 'nginx-template'
  $ctmpl_template = "${::consul_template::config_dir}/${nginx_template}.ctmpl"

  $nginx_config = '/etc/nginx/sites-enabled/_.conf'

  file { $ctmpl_template:
ensure  => 'file',
content => template("templates/${nginx_template}.ctmpl.erb"),
mode    => '0644',
owner   => 'root',
group   => 'root',
notify  => Service['consul-template'],
  }

  consul_template::watch { $nginx_template:
config_hash   => {
  command     => 'service nginx reload',
  destination => $nginx_config,
  source      => $ctmpl_template,
},
  }

  exec { $nginx_template:
command   => "consul-template -once -template '${ctmpl_template}:${nginx_config}'",
tries     => 3,
try_sleep => 1,
unless    => "/usr/bin/test -s ${nginx_config}",
notify    => Service['nginx'],
require   => [
  File[$ctmpl_template],
  Service['consul'],
],
  }

  class { 'nginx': }

  apt::ppa { 'ppa:nginx/stable': }
}
</code></pre>
<pre><code>// templates/${nginx_template}.ctmpl.erb
server {
  listen *:80;

  server_name           _;

  resolver                   8.8.8.8;
  index  index.html index.htm index.php;
  access_log            /mnt/logs/nginx/_.access.log default;
  error_log             /mnt/logs/nginx/_.error.log;

  location / {
proxy_pass             http://www,sample_website.com/{{ key "foo" }};
proxy_read_timeout     90s;
proxy_connect_timeout  90s;
proxy_send_timeout     90s;
proxy_redirect         off;
proxy_set_header       Host $host;
proxy_set_header       X-Real-IP $remote_addr;
proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header       Proxy "";
  }
</code></pre>
<p>Let's go by the parts one by one.</p>
<pre><code>// init.pp
class sample_proxy() {
  include consul_template

  $nginx_template = 'nginx-template'
  $ctmpl_template = "${::consul_template::config_dir}/${nginx_template}.ctmpl"

  $nginx_config = '/etc/nginx/sites-enabled/_.conf'
</code></pre>
<p>In this part, we just initialize file paths for our config files:</p>
<ul>
<li>The path for the consul template configuration</li>
<li>The file for the nginx config, which we will use as target when we run <code>consul-template</code>. In this case our server is named <code>_</code>, but you can change this to whatever you prefer.</li>
</ul>
<pre><code>  consul_template::watch { $nginx_template:
config_hash   => {
  command     => 'service nginx reload',
  destination => $nginx_config,
  source      => $ctmpl_template,
},
  }
</code></pre>
<p>Here, we create a <a href="https://www.consul.io/docs/commands/watch">"watch"</a> from the consul template to the target nginx file. The <code>command</code> attribute is ran every time a change is detected. So, every time the config changes, we trigger an <code>nginx reload</code>.</p>
<pre><code>exec { $nginx_template:
command   => "consul-template -once -template '${ctmpl_template}:${nginx_config}'",
tries     => 3,
try_sleep => 1,
unless    => "/usr/bin/test -s ${nginx_config}",
notify    => Service['nginx'],
require   => [
  File[$ctmpl_template],
],
  }
</code></pre>
<p>Here, we execute consul-template once to trigger the watch for the first time. If the config file already exists, it means that the nginx config has already been created and is being watched, so we don't have to run <code>consul-template</code> anymore.</p>
<pre><code>  class { 'nginx': }

  apt::ppa { 'ppa:nginx/stable': }
</code></pre>
<p>This includes the nginx module, which sets up the nginx service and whatnot.</p>
<p>Let's head over to the template for the nginx server.</p>
<pre><code>// templates/${nginx_template}.ctmpl.erb
server {
  listen *:80;

  server_name           _;

  resolver                   8.8.8.8;
  index  index.html index.htm index.php;
  access_log            /mnt/logs/nginx/_.access.log default;
  error_log             /mnt/logs/nginx/_.error.log;
}
</code></pre>
<p>In here, the server is just initialized and is listening at port 80. I had to use <code>8.8.8.8</code> as a resolver, but you can remove this part if you don't need it. The file paths for <code>access_log</code> and <code>error_log</code> can also be changed to your liking.</p>
<pre><code>  location / {
proxy_pass             http://www,sample_website.com/{{ key "foo" }};
proxy_read_timeout     90s;
proxy_connect_timeout  90s;
proxy_send_timeout     90s;
proxy_redirect         off;
proxy_set_header       Host $host;
proxy_set_header       X-Real-IP $remote_addr;
proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header       Proxy "";
  }
</code></pre>
<p>In here, we are telling nginx to forward requests from the root path to <code>http://www.sample_website.com</code> plus the value of the key <code>foo</code> in your consul KV. If this value changes, then new requests are routed to the new URI. Consul template will then restart on its own.</p>
</div></article><nav class="mt-8 flex items-center justify-between gap-4 text-sm"><div></div><div class="text-right"><a class="text-neutral-700 hover:underline" href="/openclaw-landing/blog/websockets/">Accessing websocket data using userscripts<!-- --> →</a></div></nav></main></div><!--$--><!--/$--><script src="/openclaw-landing/_next/static/chunks/b79d602f30593662.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[79520,[\"/openclaw-landing/_next/static/chunks/744355e03808d4c7.js\"],\"\"]\n3:I[39756,[\"/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js\",\"/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js\"],\"default\"]\n4:I[37457,[\"/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js\",\"/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js\"],\"default\"]\n6:I[97367,[\"/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js\",\"/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js\"],\"OutletBoundary\"]\n7:\"$Sreact.suspense\"\n9:I[97367,[\"/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js\",\"/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js\"],\"ViewportBoundary\"]\nb:I[97367,[\"/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js\",\"/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js\"],\"MetadataBoundary\"]\nd:I[68027,[],\"default\"]\n:HL[\"/openclaw-landing/_next/static/chunks/8c9da6df9e0ce34d.css\",\"style\"]\n:HL[\"/openclaw-landing/_next/static/media/797e433ab948586e-s.p.dbea232f.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/openclaw-landing/_next/static/media/caa3a2e1cccd8315-s.p.853070df.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"FmlDgMI7snZSJRl5UO4eV\",\"c\":[\"\",\"blog\",\"nginx-consul\",\"\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"nginx-consul\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/openclaw-landing/_next/static/chunks/8c9da6df9e0ce34d.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-0\",{\"src\":\"/openclaw-landing/_next/static/chunks/744355e03808d4c7.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"geist_a71539c9-module__T19VSG__variable geist_mono_8d43a2aa-module__8Li5zG__variable antialiased\",\"children\":[[\"$\",\"$L2\",null,{\"id\":\"ld-person\",\"type\":\"application/ld+json\",\"dangerouslySetInnerHTML\":{\"__html\":\"{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@type\\\":\\\"Person\\\",\\\"name\\\":\\\"Kelly Navarro\\\",\\\"jobTitle\\\":\\\"Site Reliability Engineer\\\",\\\"url\\\":\\\"https://gabrnavarro.github.io/openclaw-landing/\\\"}\"}}],[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",[[\"$\",\"script\",\"script-0\",{\"src\":\"/openclaw-landing/_next/static/chunks/7c92e96509cd355e.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"$L6\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@8\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.Metadata\",\"children\":\"$Lc\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"e:I[22016,[\"/openclaw-landing/_next/static/chunks/744355e03808d4c7.js\",\"/openclaw-landing/_next/static/chunks/7c92e96509cd355e.js\"],\"\"]\nf:T15ee,"])</script><script>self.__next_f.push([1,"\u003cp\u003eConsul template is a wonderful tool that allows you to create configuration templates while interpolating consul resources and many important variables. You can also use these templates to automatically change the contents of your configuration files using the \u003ccode\u003ewatch\u003c/code\u003e class in puppet.\u003c/p\u003e\n\u003cp\u003eTo set up an nginx proxy using consul-template to control configuration, what you can do is initialize nginx using the \u003ccode\u003epuppet-nginx\u003c/code\u003e module and change the config files using consul template.\u003c/p\u003e\n\u003cp\u003eHere is the full code for reference. This is just what it should roughly look like, and I haven't tested this, so please read it and just take whichever parts you need to make it work.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// init.pp\nclass sample_proxy() {\n  include consul_template\n\n  $nginx_template = 'nginx-template'\n  $ctmpl_template = \"${::consul_template::config_dir}/${nginx_template}.ctmpl\"\n\n  $nginx_config = '/etc/nginx/sites-enabled/_.conf'\n\n  file { $ctmpl_template:\nensure  =\u003e 'file',\ncontent =\u003e template(\"templates/${nginx_template}.ctmpl.erb\"),\nmode    =\u003e '0644',\nowner   =\u003e 'root',\ngroup   =\u003e 'root',\nnotify  =\u003e Service['consul-template'],\n  }\n\n  consul_template::watch { $nginx_template:\nconfig_hash   =\u003e {\n  command     =\u003e 'service nginx reload',\n  destination =\u003e $nginx_config,\n  source      =\u003e $ctmpl_template,\n},\n  }\n\n  exec { $nginx_template:\ncommand   =\u003e \"consul-template -once -template '${ctmpl_template}:${nginx_config}'\",\ntries     =\u003e 3,\ntry_sleep =\u003e 1,\nunless    =\u003e \"/usr/bin/test -s ${nginx_config}\",\nnotify    =\u003e Service['nginx'],\nrequire   =\u003e [\n  File[$ctmpl_template],\n  Service['consul'],\n],\n  }\n\n  class { 'nginx': }\n\n  apt::ppa { 'ppa:nginx/stable': }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003e// templates/${nginx_template}.ctmpl.erb\nserver {\n  listen *:80;\n\n  server_name           _;\n\n  resolver                   8.8.8.8;\n  index  index.html index.htm index.php;\n  access_log            /mnt/logs/nginx/_.access.log default;\n  error_log             /mnt/logs/nginx/_.error.log;\n\n  location / {\nproxy_pass             http://www,sample_website.com/{{ key \"foo\" }};\nproxy_read_timeout     90s;\nproxy_connect_timeout  90s;\nproxy_send_timeout     90s;\nproxy_redirect         off;\nproxy_set_header       Host $host;\nproxy_set_header       X-Real-IP $remote_addr;\nproxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header       Proxy \"\";\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet's go by the parts one by one.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// init.pp\nclass sample_proxy() {\n  include consul_template\n\n  $nginx_template = 'nginx-template'\n  $ctmpl_template = \"${::consul_template::config_dir}/${nginx_template}.ctmpl\"\n\n  $nginx_config = '/etc/nginx/sites-enabled/_.conf'\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn this part, we just initialize file paths for our config files:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe path for the consul template configuration\u003c/li\u003e\n\u003cli\u003eThe file for the nginx config, which we will use as target when we run \u003ccode\u003econsul-template\u003c/code\u003e. In this case our server is named \u003ccode\u003e_\u003c/code\u003e, but you can change this to whatever you prefer.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode\u003e  consul_template::watch { $nginx_template:\nconfig_hash   =\u003e {\n  command     =\u003e 'service nginx reload',\n  destination =\u003e $nginx_config,\n  source      =\u003e $ctmpl_template,\n},\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere, we create a \u003ca href=\"https://www.consul.io/docs/commands/watch\"\u003e\"watch\"\u003c/a\u003e from the consul template to the target nginx file. The \u003ccode\u003ecommand\u003c/code\u003e attribute is ran every time a change is detected. So, every time the config changes, we trigger an \u003ccode\u003enginx reload\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eexec { $nginx_template:\ncommand   =\u003e \"consul-template -once -template '${ctmpl_template}:${nginx_config}'\",\ntries     =\u003e 3,\ntry_sleep =\u003e 1,\nunless    =\u003e \"/usr/bin/test -s ${nginx_config}\",\nnotify    =\u003e Service['nginx'],\nrequire   =\u003e [\n  File[$ctmpl_template],\n],\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere, we execute consul-template once to trigger the watch for the first time. If the config file already exists, it means that the nginx config has already been created and is being watched, so we don't have to run \u003ccode\u003econsul-template\u003c/code\u003e anymore.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e  class { 'nginx': }\n\n  apt::ppa { 'ppa:nginx/stable': }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis includes the nginx module, which sets up the nginx service and whatnot.\u003c/p\u003e\n\u003cp\u003eLet's head over to the template for the nginx server.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// templates/${nginx_template}.ctmpl.erb\nserver {\n  listen *:80;\n\n  server_name           _;\n\n  resolver                   8.8.8.8;\n  index  index.html index.htm index.php;\n  access_log            /mnt/logs/nginx/_.access.log default;\n  error_log             /mnt/logs/nginx/_.error.log;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn here, the server is just initialized and is listening at port 80. I had to use \u003ccode\u003e8.8.8.8\u003c/code\u003e as a resolver, but you can remove this part if you don't need it. The file paths for \u003ccode\u003eaccess_log\u003c/code\u003e and \u003ccode\u003eerror_log\u003c/code\u003e can also be changed to your liking.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e  location / {\nproxy_pass             http://www,sample_website.com/{{ key \"foo\" }};\nproxy_read_timeout     90s;\nproxy_connect_timeout  90s;\nproxy_send_timeout     90s;\nproxy_redirect         off;\nproxy_set_header       Host $host;\nproxy_set_header       X-Real-IP $remote_addr;\nproxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header       Proxy \"\";\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn here, we are telling nginx to forward requests from the root path to \u003ccode\u003ehttp://www.sample_website.com\u003c/code\u003e plus the value of the key \u003ccode\u003efoo\u003c/code\u003e in your consul KV. If this value changes, then new requests are routed to the new URI. Consul template will then restart on its own.\u003c/p\u003e\n"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"className\":\"min-h-screen bg-white text-neutral-950\",\"children\":[[\"$\",\"div\",null,{\"className\":\"pointer-events-none fixed inset-0 -z-10\",\"children\":[[\"$\",\"div\",null,{\"className\":\"absolute inset-0 bg-gradient-to-b from-white via-white to-zinc-50\"}],[\"$\",\"div\",null,{\"className\":\"absolute left-1/2 top-[-240px] h-[520px] w-[520px] -translate-x-1/2 rounded-full bg-blue-200/35 blur-3xl\"}],[\"$\",\"div\",null,{\"className\":\"absolute left-[20%] top-[240px] h-[420px] w-[420px] rounded-full bg-emerald-200/25 blur-3xl\"}]]}],[\"$\",\"main\",null,{\"className\":\"mx-auto w-full max-w-3xl px-6 py-16 sm:py-20\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex items-center justify-between\",\"children\":[[\"$\",\"$Le\",null,{\"href\":\"/blog\",\"className\":\"inline-flex h-10 items-center justify-center rounded-full border border-neutral-200 bg-white px-4 text-sm font-medium text-neutral-900 shadow-sm transition hover:bg-neutral-50\",\"children\":\"← Blog\"}],[\"$\",\"$Le\",null,{\"href\":\"/\",\"className\":\"inline-flex h-10 items-center justify-center rounded-full border border-neutral-200 bg-white px-4 text-sm font-medium text-neutral-900 shadow-sm transition hover:bg-neutral-50\",\"children\":\"Home\"}]]}],[\"$\",\"article\",null,{\"className\":\"mt-10 overflow-hidden rounded-3xl border border-neutral-200 bg-white shadow-sm\",\"children\":[[\"$\",\"header\",null,{\"className\":\"border-b border-neutral-100 p-6 sm:p-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"text-xs text-neutral-500\",\"children\":\"July 26, 2020\"}],[\"$\",\"h1\",null,{\"className\":\"mt-2 text-3xl font-semibold tracking-tight\",\"children\":\"Setting up an NGINX proxy using consul-template and puppet\"}],[\"$\",\"div\",null,{\"className\":\"mt-4 flex flex-wrap gap-2\",\"children\":[[\"$\",\"span\",\"nginx\",{\"className\":\"rounded-full border border-neutral-200 bg-white px-2.5 py-1 text-[11px] text-neutral-700\",\"children\":\"nginx\"}],[\"$\",\"span\",\"consul\",{\"className\":\"rounded-full border border-neutral-200 bg-white px-2.5 py-1 text-[11px] text-neutral-700\",\"children\":\"consul\"}],[\"$\",\"span\",\"puppet\",{\"className\":\"rounded-full border border-neutral-200 bg-white px-2.5 py-1 text-[11px] text-neutral-700\",\"children\":\"puppet\"}]]}]]}],[\"$\",\"div\",null,{\"className\":\"prose prose-neutral blog-prose max-w-none p-6 sm:p-8 prose-headings:tracking-tight prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline\",\"dangerouslySetInnerHTML\":{\"__html\":\"$f\"}}]]}],\"$L10\"]}]]}]\n"])</script><script>self.__next_f.push([1,"10:[\"$\",\"nav\",null,{\"className\":\"mt-8 flex items-center justify-between gap-4 text-sm\",\"children\":[[\"$\",\"div\",null,{\"children\":null}],[\"$\",\"div\",null,{\"className\":\"text-right\",\"children\":[\"$\",\"$Le\",null,{\"className\":\"text-neutral-700 hover:underline\",\"href\":\"/blog/websockets\",\"children\":[\"Accessing websocket data using userscripts\",\" →\"]}]}]]}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"11:I[27201,[\"/openclaw-landing/_next/static/chunks/ff1a16fafef87110.js\",\"/openclaw-landing/_next/static/chunks/d2be314c3ece3fbe.js\"],\"IconMark\"]\n8:null\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"title\",\"0\",{\"children\":\"Setting up an NGINX proxy using consul-template and puppet · Blog\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Blog post from 2020-07-26: Setting up an NGINX proxy using consul-template and puppet\"}],[\"$\",\"meta\",\"2\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"3\",{\"name\":\"googlebot\",\"content\":\"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"canonical\",\"href\":\"https://gabrnavarro.github.io/openclaw-landing/\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Kelly Navarro — Site Reliability Engineer\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"SRE with 7+ years running large-scale game and web infrastructure across AWS, GCP, and Azure.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:url\",\"content\":\"https://gabrnavarro.github.io/openclaw-landing/\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:site_name\",\"content\":\"Kelly Navarro\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:title\",\"content\":\"Kelly Navarro — Site Reliability Engineer\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:description\",\"content\":\"SRE with 7+ years running large-scale game and web infrastructure across AWS, GCP, and Azure.\"}],[\"$\",\"link\",\"13\",{\"rel\":\"icon\",\"href\":\"/openclaw-landing/favicon.ico?favicon.0b3bf435.ico\",\"sizes\":\"256x256\",\"type\":\"image/x-icon\"}],[\"$\",\"$L11\",\"14\",{}]]\n"])</script></body></html>